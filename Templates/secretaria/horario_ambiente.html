<!doctype html>
{% load get_item %}
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <title>Gestión de Ambientes</title>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-danger shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{% url 'secretaria_dashboard' %}">Sistema de Gestión Académica</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="{% url 'secretaria_dashboard' %}">Panel Principal</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'secretaria_reportes' %}">Reportes</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'secretaria_matriculas_lab' %}">Matrículas Lab.</a></li>
                    <li class="nav-item"><a class="nav-link active" href="{% url 'secretaria_horario_ambiente' %}">Gestión Ambientes</a></li>
                    <li class="nav-item"><a class="nav-link text-warning" href="{% url 'logout' %}">Cerrar Sesión</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        <h1 class="mb-4">Gestión y Supervisión de Ambientes</h1>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form method="get" id="form-ambiente" class="row g-3 align-items-end">
                    <div class="col-md-5">
                        <label class="form-label fw-bold">Seleccionar Ambiente</label>
                        <select name="ambiente" class="form-select" onchange="document.getElementById('form-ambiente').submit()">
                            {% for a in ambientes %}
                            <option value="{{ a.codigo }}" {% if ambiente.codigo == a.codigo %}selected{% endif %}>
                                {{ a.nombre }} ({{ a.get_tipo_display }}) - Capacidad: {{ a.capacidad }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Fecha de Referencia</label>
                        <input type="date" name="fecha" class="form-control" value="{{ fecha_seleccionada }}" onchange="document.getElementById('form-ambiente').submit()">
                    </div>
                    <div class="col-md-4 text-end">
                         <div class="badge bg-primary p-2">Clases Regulares (2025-B)</div>
                         <div class="badge bg-warning text-dark p-2">Reservas</div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card shadow-sm">
             <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Horario: {{ ambiente.nombre }}</h5>
                <small>Semana del {{ dias.0|date:"d/m" }} al {{ dias.4|date:"d/m" }}</small>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered text-center table-sm mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 100px;">Hora</th>
                            {% for d in dias %}
                            <th>{{ d|date:"l d/m" }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for idx, bloque in bloques %}
                        <tr>
                            <td class="align-middle bg-light"><strong>{{ bloque.0 }}<br>{{ bloque.1 }}</strong></td>
            
                            {% for d in dias %}
                            {% with celda=tabla|get_item:d.day|get_item:idx %}
                            <td class="align-middle p-1 position-relative" style="height: 60px;">
                                
                                {% if celda %}
                                    
                                    {% if celda.tipo == 'CLASE' %}
                                        <div class="badge bg-primary w-100 p-2 text-wrap shadow-sm h-100 d-flex flex-column justify-content-center">
                                            <div><i class="bi bi-book"></i> {{ celda.curso.codigo }}</div>
                                            <small>{{ celda.curso.nombre|truncatechars:20 }}</small>
                                            <small class="fw-light">{{ celda.profesor.usuario.apellidos }}</small>
                                        </div>
            
                                    {% elif celda.tipo == 'RESERVA' or celda.tipo == 'RESERVA_EXT' %}
                                        <div class="badge bg-warning text-dark w-100 p-2 text-wrap shadow-sm h-100 d-flex flex-column justify-content-center">
                                            <div><i class="bi bi-calendar-event"></i> RESERVADO</div>
                                            <small>{{ celda.curso.nombre|default:"Sin Curso"|truncatechars:20 }}</small>
                                            <small class="fw-light">{{ celda.profesor.usuario.apellidos }}</small>
                                        </div>
                                    {% endif %}
            
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center text-muted h-100 opacity-25">
                                        <small>-</small>
                                    </div>
                                {% endif %}
            
                            </td>
                            {% endwith %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>