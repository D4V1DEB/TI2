{% load static %}

<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestión de Horarios de Cursos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .horario-cell {
            min-height: 70px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .horario-cell:hover:not(.ocupado) {
            background-color: #e3f2fd !important;
        }

        .horario-cell.seleccionado-teoria {
            background-color: #2196f3 !important;
            color: white;
        }

        .horario-cell.seleccionado-practica {
            background-color: #ff9800 !important;
            color: white;
        }

        .horario-cell.seleccionado-laboratorio {
            background-color: #4caf50 !important;
            color: white;
        }

        .horario-cell.ocupado {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .curso-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .curso-item:hover {
            background-color: #e3f2fd;
        }

        .curso-item.activo {
            background-color: #2196f3;
            color: white;
        }

        .badge-horas {
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
        }
    </style>
</head>

<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="{% url 'secretaria_dashboard' %}">Sistema Académico</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="{% url 'secretaria_dashboard' %}">Panel Principal</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'listar_cursos' %}">Cursos</a></li>
                    <li class="nav-item"><a class="nav-link active"
                            href="{% url 'secretaria_horarios_cursos' %}">Horarios</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'secretaria_matriculas' %}">Matrículas</a>
                    </li>
                    <li class="nav-item"><a class="nav-link text-warning" href="{% url 'logout' %}">Cerrar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid mt-4">
        <div class="row">
            <!-- LISTA DE CURSOS -->
            <div class="col-md-3">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-book me-2"></i>Cursos</h5>
                    </div>
                    <div class="card-body p-0" style="max-height: 80vh; overflow-y: auto;">
                        <div class="list-group list-group-flush">
                            {% for curso in cursos %}
                            <div class="list-group-item curso-item p-3" data-codigo="{{ curso.codigo }}"
                                data-nombre="{{ curso.nombre }}" data-teoria="{{ curso.horas_teoria }}"
                                data-practica="{{ curso.horas_practica }}" data-lab="{{ curso.horas_laboratorio }}"
                                data-tiene-grupo-b="{{ curso.tiene_grupo_b }}" onclick="seleccionarCurso(this)">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <strong>{{ curso.codigo }}</strong><br>
                                        <small>{{ curso.nombre|truncatechars:30 }}</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    {% if curso.horas_teoria > 0 %}
                                    <span class="badge bg-primary badge-horas">T: {{ curso.horas_teoria }}h</span>
                                    {% endif %}
                                    {% if curso.horas_practica > 0 %}
                                    <span class="badge bg-warning badge-horas">P: {{ curso.horas_practica }}h</span>
                                    {% endif %}
                                    {% if curso.horas_laboratorio > 0 %}
                                    <span class="badge bg-success badge-horas">L: {{ curso.horas_laboratorio }}h</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRID DE HORARIOS -->
            <div class="col-md-9">
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-secondary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-calendar-week me-2"></i>Grid de Horarios - Periodo 2025-B
                            </h5>
                            <span class="badge bg-light text-dark">Lunes a Viernes</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Información del curso seleccionado -->
                        <div id="infoCursoSeleccionado" class="p-3 bg-light border-bottom" style="display:none;">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-1"><strong id="cursoNombre">-</strong></h6>
                                    <small class="text-muted">Código: <span id="cursoCodigo">-</span></small>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label mb-1"><strong>Grupo:</strong></label>
                                    <select id="selectGrupo" class="form-select form-select-sm"
                                        onchange="cambiarGrupo()">
                                        <!-- Se llena dinámicamente según el curso -->
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label mb-1"><strong>Ubicación:</strong></label>
                                    <select id="selectUbicacion" class="form-select form-select-sm">
                                        <option value="">Seleccionar...</option>
                                        <!-- Se llena dinámicamente -->
                                    </select>
                                </div>
                                <div class="col-md-3 text-end">
                                    <button class="btn btn-success btn-sm" onclick="guardarHorarios()">
                                        <i class="bi bi-save me-1"></i>Guardar Horarios
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <div id="tiposClase"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Grid semanal -->
                        <div class="table-responsive">
                            <table class="table table-bordered text-center mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 120px;">Hora</th>
                                        <th>Lunes</th>
                                        <th>Martes</th>
                                        <th>Miércoles</th>
                                        <th>Jueves</th>
                                        <th>Viernes</th>
                                    </tr>
                                </thead>
                                <tbody id="gridHorarios">
                                    <!-- Se llena dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Leyenda -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <strong>Leyenda:</strong>
                        <span class="badge bg-primary ms-2">Teoría</span>
                        <span class="badge bg-warning ms-2">Práctica</span>
                        <span class="badge bg-success ms-2">Laboratorio</span>
                        <span class="badge bg-secondary ms-2">Ocupado</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const DIAS = [
            { value: 1, text: 'Lunes' },
            { value: 2, text: 'Martes' },
            { value: 3, text: 'Miércoles' },
            { value: 4, text: 'Jueves' },
            { value: 5, text: 'Viernes' }
        ];

        const BLOQUES_HORARIOS = [
            ['07:00', '07:50'],
            ['07:50', '08:40'],
            ['08:50', '09:40'],
            ['09:40', '10:30'],
            ['10:40', '12:20'],
            ['12:20', '14:00'],
            ['14:00', '14:50'],
            ['14:50', '15:40'],
            ['15:50', '16:40'],
            ['16:40', '17:30'],
            ['17:40', '18:30'],
            ['18:30', '19:20']
        ];

        let horariosOcupados = [];
        let cursoSeleccionado = null;
        let grupoSeleccionado = 'A';
        let horariosSeleccionados = []; // [{dia, hora_inicio, hora_fin, tipo}]
        let tipoActual = null; // 'TEORIA', 'PRACTICA', 'LABORATORIO'

        // Cargar horarios ocupados al iniciar
        async function cargarHorariosOcupados() {
            try {
                const ubicacionSelect = document.getElementById('selectUbicacion');
                const ubicacion = ubicacionSelect ? ubicacionSelect.value : '';

                // Si no hay ubicación seleccionada, no cargar horarios
                if (!ubicacion) {
                    clearOccupiedMarkings(); // Clear any previously marked occupied cells
                    return;
                }

                const url = `/secretaria/horarios/ocupados/?ubicacion=${encodeURIComponent(ubicacion)}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('Error al cargar horarios ocupados');
                }

                const data = await response.json();
                horariosOcupados = data.horarios || [];

                // Marcar celdas ocupadas en el grid
                marcarHorariosOcupados();

            } catch (error) {
                console.error('Error:', error);
            }
        }

        function generarGrid() {
            const tbody = document.getElementById('gridHorarios');
            tbody.innerHTML = '';

            BLOQUES_HORARIOS.forEach((bloque, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="align-middle"><strong>${bloque[0]}<br>${bloque[1]}</strong></td>`;

                DIAS.forEach(dia => {
                    const td = document.createElement('td');
                    td.className = 'horario-cell align-middle';
                    td.dataset.dia = dia.value;
                    td.dataset.inicio = bloque[0];
                    td.dataset.fin = bloque[1];

                    const ocupado = esHorarioOcupado(dia.value, bloque[0], bloque[1]);
                    if (ocupado) {
                        td.classList.add('ocupado');
                        const tipoCorto = ocupado.tipo_clase === 'TEORIA' ? 'T' :
                            ocupado.tipo_clase === 'PRACTICA' ? 'P' : 'L';
                        td.innerHTML = `
                            <small class="text-muted">
                                <strong>${ocupado.curso__codigo}</strong><br>
                                ${tipoCorto} - ${ocupado.grupo}
                            </small>`;
                    } else {
                        td.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Libre</small>';
                        td.onclick = () => seleccionarHorario(td);
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function esHorarioOcupado(dia, horaInicio, horaFin) {
            return horariosOcupados.find(h =>
                h.dia_semana == dia &&
                ((h.hora_inicio >= horaInicio && h.hora_inicio < horaFin) ||
                    (h.hora_fin > horaInicio && h.hora_fin <= horaFin) ||
                    (h.hora_inicio <= horaInicio && h.hora_fin >= horaFin))
            );
        }

        function seleccionarCurso(element) {
            // Marcar como activo
            document.querySelectorAll('.curso-item').forEach(el => el.classList.remove('activo'));
            element.classList.add('activo');

            cursoSeleccionado = {
                codigo: element.dataset.codigo,
                nombre: element.dataset.nombre,
                teoria: parseInt(element.dataset.teoria),
                practica: parseInt(element.dataset.practica),
                lab: parseInt(element.dataset.lab),
                tiene_grupo_b: element.dataset.tieneGrupoB === 'True'
            };

            document.getElementById('cursoCodigo').textContent = cursoSeleccionado.codigo;
            document.getElementById('cursoNombre').textContent = cursoSeleccionado.nombre;
            document.getElementById('infoCursoSeleccionado').style.display = 'block';

            // Cargar grupos dinámicamente
            const selectGrupo = document.getElementById('selectGrupo');
            selectGrupo.innerHTML = '<option value="A">Grupo A</option>';
            if (cursoSeleccionado.tiene_grupo_b) {
                selectGrupo.innerHTML += '<option value="B">Grupo B</option>';
            }
            grupoSeleccionado = 'A';

            // Cargar ubicaciones
            cargarUbicaciones();

            // Agregar listener para cambio de ubicación
            const selectUbicacion = document.getElementById('selectUbicacion');
            selectUbicacion.addEventListener('change', function () {
                cargarHorariosOcupados();
                generarGrid();
            });

            mostrarTiposClase();
            cargarHorariosCurso();
        }

        function mostrarTiposClase() {
            const container = document.getElementById('tiposClase');
            let html = '<strong>Seleccionar tipo de clase:</strong> ';

            if (cursoSeleccionado.teoria > 0) {
                html += `<button class="btn btn-sm btn-primary ms-2" onclick="seleccionarTipo('TEORIA')">
            <i class="bi bi-book"></i> Teoría (${cursoSeleccionado.teoria}h)
        </button>`;
            }
            if (cursoSeleccionado.practica > 0) {
                html += `<button class="btn btn-sm btn-warning ms-2" onclick="seleccionarTipo('PRACTICA')">
            <i class="bi bi-pencil"></i> Práctica (${cursoSeleccionado.practica}h)
        </button>`;
            }
            if (cursoSeleccionado.lab > 0) {
                html += `<button class="btn btn-sm btn-success ms-2" onclick="seleccionarTipo('LABORATORIO')">
            <i class="bi bi-cpu"></i> Laboratorio (${cursoSeleccionado.lab}h)
        </button>`;
            }

            container.innerHTML = html;
        }

        function seleccionarTipo(tipo) {
            tipoActual = tipo;
            // NO reducir horas aquí, solo cambiar el tipo activo
            // Las horas se reducen cuando se coloca en el grid
            actualizarContadorHoras();
        }

        function actualizarContadorHoras() {
            if (!cursoSeleccionado) return;

            // Contar horas ya seleccionadas por tipo
            const horasTeoria = horariosSeleccionados.filter(h => h.tipo === 'TEORIA').length;
            const horasPractica = horariosSeleccionados.filter(h => h.tipo === 'PRACTICA').length;
            const horasLab = horariosSeleccionados.filter(h => h.tipo === 'LABORATORIO').length;

            let html = '<strong>Seleccionar tipo de clase:</strong> ';

            if (cursoSeleccionado.teoria > 0) {
                const falt = cursoSeleccionado.teoria - horasTeoria;
                const isActive = tipoActual === 'TEORIA';
                html += `<button class="btn btn-sm btn-primary ms-2 ${isActive ? 'active' : ''}" onclick="seleccionarTipo('TEORIA')">
                    <i class="bi bi-book"></i> Teoría (${cursoSeleccionado.teoria}h)
                    - Faltan ${Math.max(0, falt)}h
                </button>`;
            }
            if (cursoSeleccionado.practica > 0) {
                const falt = cursoSeleccionado.practica - horasPractica;
                const isActive = tipoActual === 'PRACTICA';
                html += `<button class="btn btn-sm btn-warning ms-2 ${isActive ? 'active' : ''}" onclick="seleccionarTipo('PRACTICA')">
                    <i class="bi bi-pencil"></i> Práctica (${cursoSeleccionado.practica}h)
                    - Faltan ${Math.max(0, falt)}h
                </button>`;
            }
            if (cursoSeleccionado.lab > 0) {
                const falt = cursoSeleccionado.lab - horasLab;
                const isActive = tipoActual === 'LABORATORIO';
                html += `<button class="btn btn-sm btn-success ms-2 ${isActive ? 'active' : ''}" onclick="seleccionarTipo('LABORATORIO')">
                    <i class="bi bi-cpu"></i> Laboratorio (${cursoSeleccionado.lab}h)
                    - Faltan ${Math.max(0, falt)}h
                </button>`;
            }

            const container = document.getElementById('tiposClase');
            if (container) container.innerHTML = html;
        }

        function seleccionarHorario(cell) {
            if (!cursoSeleccionado) {
                alert('Primero selecciona un curso');
                return;
            }

            if (!tipoActual) {
                alert('Primero selecciona un tipo de clase (Teoría, Práctica o Laboratorio)');
                return;
            }

            const dia = parseInt(cell.dataset.dia);
            const inicio = cell.dataset.inicio;
            const fin = cell.dataset.fin;

            // Toggle selección
            const yaSeleccionado = horariosSeleccionados.findIndex(h =>
                h.dia == dia && h.hora_inicio == inicio && h.tipo == tipoActual
            );

            if (yaSeleccionado >= 0) {
                // Deseleccionar
                horariosSeleccionados.splice(yaSeleccionado, 1);
                cell.className = 'horario-cell align-middle';
                cell.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Libre</small>';
            } else {
                // Verificar límite de horas
                const horasSeleccionadas = horariosSeleccionados.filter(h => h.tipo === tipoActual).length;
                let horasRequeridas = 0;
                if (tipoActual === 'TEORIA') horasRequeridas = cursoSeleccionado.teoria;
                else if (tipoActual === 'PRACTICA') horasRequeridas = cursoSeleccionado.practica;
                else if (tipoActual === 'LABORATORIO') horasRequeridas = cursoSeleccionado.lab;

                if (horasSeleccionadas >= horasRequeridas) {
                    alert(`Ya seleccionaste las ${horasRequeridas} horas requeridas para ${tipoActual}. Deselecciona alguna si quieres cambiar.`);
                    return;
                }

                // Seleccionar
                horariosSeleccionados.push({
                    dia: dia,
                    hora_inicio: inicio,
                    hora_fin: fin,
                    tipo: tipoActual
                });

                const clase = tipoActual === 'TEORIA' ? 'seleccionado-teoria' :
                    tipoActual === 'PRACTICA' ? 'seleccionado-practica' : 'seleccionado-laboratorio';
                const tipoCorto = tipoActual === 'TEORIA' ? 'TEORIA' : tipoActual === 'PRACTICA' ? 'PRACTICA' : 'LABORATORIO';
                cell.className = `horario-cell align-middle ${clase}`;
                cell.innerHTML = `
                    <small class="text-white">
                        <strong>${cursoSeleccionado.nombre}</strong><br>
                        ${tipoCorto} - ${grupoSeleccionado}
                    </small>`;
            }

            // Actualizar contador
            actualizarContadorHoras();
        }

        function cambiarGrupo() {
            grupoSeleccionado = document.getElementById('selectGrupo').value;
            horariosSeleccionados = [];
            generarGrid();
            cargarHorariosCurso();
        }

        async function cargarHorariosCurso() {
            if (!cursoSeleccionado) return;

            try {
                const response = await fetch(`/secretaria/horarios/curso/${cursoSeleccionado.codigo}/${grupoSeleccionado}/`);
                const data = await response.json();

                horariosSeleccionados = data.horarios.map(h => ({
                    dia: h.dia_semana,
                    hora_inicio: h.hora_inicio,
                    hora_fin: h.hora_fin,
                    tipo: h.tipo_clase,
                    ubicacion: h.ubicacion__codigo
                }));

                // Marcar en el grid
                generarGrid();
                horariosSeleccionados.forEach(h => {
                    const cell = document.querySelector(
                        `[data-dia="${h.dia}"][data-inicio="${h.hora_inicio}"]`
                    );
                    if (cell && !cell.classList.contains('ocupado')) {
                        const clase = h.tipo === 'TEORIA' ? 'seleccionado-teoria' :
                            h.tipo === 'PRACTICA' ? 'seleccionado-practica' : 'seleccionado-laboratorio';
                        const tipoCorto = h.tipo === 'TEORIA' ? 'T' : h.tipo === 'PRACTICA' ? 'P' : 'L';
                        cell.className = `horario-cell align-middle ${clase}`;
                        cell.innerHTML = `
                            <small class="text-white">
                                <strong>${cursoSeleccionado.codigo}</strong><br>
                                ${tipoCorto} - ${grupoSeleccionado}
                            </small>`;
                    }
                });

            } catch (err) {
                console.error('Error cargando horarios del curso:', err);
            }
        }

        async function guardarHorarios() {
            if (!cursoSeleccionado) {
                alert('Selecciona un curso primero');
                return;
            }

            const selectUbicacion = document.getElementById('selectUbicacion');
            const ubicacion = selectUbicacion ? selectUbicacion.value : '';

            if (!ubicacion) {
                alert('Debes seleccionar una ubicación (aula/laboratorio)');
                return;
            }

            if (horariosSeleccionados.length === 0) {
                alert('No has seleccionado ningún horario');
                return;
            }

            try {
                const response = await fetch('/secretaria/horarios/guardar/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        curso_codigo: cursoSeleccionado.codigo,
                        grupo: grupoSeleccionado,
                        horarios: horariosSeleccionados.map(h => ({
                            dia: h.dia,
                            hora_inicio: h.hora_inicio,
                            hora_fin: h.hora_fin,
                            tipo: h.tipo,
                            ubicacion: ubicacion
                        }))
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(data.message);
                    horariosSeleccionados = [];
                    cargarHorariosOcupados();
                    generarGrid();
                } else {
                    alert('Error: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error guardando horarios:', error);
                alert('Error al guardar horarios');
            }
        }

        async function cargarUbicaciones() {
            // Ubicaciones fijas de la base de datos (ambientes)
            const ubicaciones = [
                { codigo: 'AULA-101', nombre: 'Aula 101', tipo: 'aula' },
                { codigo: 'AULA-201', nombre: 'Aula 201', tipo: 'aula' },
                { codigo: 'AULA-202', nombre: 'Aula 202', tipo: 'aula' },
                { codigo: 'AULA-203', nombre: 'Aula 203', tipo: 'aula' },
                { codigo: 'AULA-301', nombre: 'Aula 301', tipo: 'aula' },
                { codigo: 'LAB-1', nombre: 'Laboratorio 1', tipo: 'lab' },
                { codigo: 'LAB-2', nombre: 'Laboratorio 2', tipo: 'lab' },
                { codigo: 'LAB-3', nombre: 'Laboratorio 3', tipo: 'lab' }
            ];

            const select = document.getElementById('selectUbicacion');
            select.innerHTML = '<option value="">Seleccionar...</option>';

            ubicaciones.forEach(ub => {
                select.innerHTML += `<option value="${ub.codigo}">${ub.nombre}</option>`;
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Inicializar
        cargarHorariosOcupados();
    </script>

</body>

</html>