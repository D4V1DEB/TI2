{% load static %}

<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gestión de Laboratorios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .lab-card {
            transition: all 0.3s;
        }

        .lab-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .badge-cupos {
            font-size: 0.9rem;
        }

        .horario-cell {
            min-height: 60px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .horario-cell:hover:not(.ocupado) {
            background-color: #e3f2fd !important;
        }

        .horario-cell.seleccionado {
            background-color: #4caf50 !important;
            color: white;
        }

        .horario-cell.ocupado {
            cursor: not-allowed;
        }
    </style>
</head>

<body class="bg-light">

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="{% if usuario.tipo_usuario.nombre == 'Administrador' %}{% url 'admin_dashboard' %}{% else %}{% url 'secretaria_dashboard' %}{% endif %}">
                <i class="bi {% if usuario.tipo_usuario.nombre == 'Administrador' %}bi-shield-fill{% else %}bi-clipboard-check-fill{% endif %} me-2"></i>
                Portal {% if usuario.tipo_usuario.nombre == 'Administrador' %}Administrador{% else %}Secretaría{% endif %}
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% if usuario.tipo_usuario.nombre == 'Administrador' %}{% url 'admin_dashboard' %}{% else %}{% url 'secretaria_dashboard' %}{% endif %}">
                            <i class="bi bi-house-fill me-1"></i>Panel Principal
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'secretaria_matriculas' %}">Matrículas</a>
                    </li>
                    <li class="nav-item"><a class="nav-link active"
                            href="{% url 'secretaria_laboratorios' %}">Laboratorios</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'secretaria_horario_ambiente' %}">Gestión
                            Ambientes</a></li>
                    <li class="nav-item">
                        <span class="nav-link text-white">
                            <i class="bi bi-person-circle me-1"></i>{{ usuario.nombre_completo }}
                        </span>
                    </li>
                    <li class="nav-item"><a class="nav-link text-warning" href="{% url 'logout' %}">Cerrar Sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid mt-4">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-cpu me-2"></i>Gestión de Laboratorios</h1>
            <span class="badge bg-secondary fs-6">Periodo 2025-B</span>
        </div>

        <!-- ALERTAS -->
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}

        <!-- CREAR LABORATORIOS -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Crear Grupos de Laboratorio</h5>
            </div>
            <div class="card-body">
                <form id="formCrearLab" method="post" action="{% url 'crear_laboratorios' %}">
                    {% csrf_token %}

                    <!-- Paso 1: Seleccionar Curso -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">1. Seleccionar Curso con Laboratorio</label>
                            <select name="curso" id="selectCurso" class="form-select" required>
                                <option value="">-- Seleccionar --</option>
                                {% for curso in cursos_con_lab %}
                                <option value="{{ curso.codigo }}">
                                    {{ curso.codigo }} - {{ curso.nombre }} ({{ curso.horas_laboratorio }}h lab)
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Información del Curso (se llena dinámicamente) -->
                    <div id="infoCurso" style="display:none;" class="mb-4">
                        <div class="alert alert-info">
                            <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>Información del Curso</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Horas de Laboratorio:</strong> <span id="horasLab">0</span>h
                                </div>
                                <div class="col-md-8">
                                    <strong>Grupos Existentes:</strong> <span id="gruposExistentes">-</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <strong>Horarios del Curso (Teoría/Práctica/Lab):</strong>
                                <div id="horariosExistentes" class="mt-1"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 2: Configurar Grupos -->
                    <div id="paso2" style="display:none;">
                        <label class="form-label fw-bold">2. Configurar Grupos de Laboratorio</label>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Grupos a Crear:</label>
                                <input type="text" name="grupos" id="inputGrupos" class="form-control"
                                    placeholder="Ej: C,D" required>
                                <small class="text-muted">Separados por comas. Grupos adicionales: C, D, E</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Capacidad por Grupo:</label>
                                <input type="number" name="capacidad" class="form-control" value="20" min="1" max="30"
                                    required>
                                <small class="text-muted">Estudiantes por grupo</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Profesor Encargado:</label>
                                <select name="profesor" id="selectProfesor" class="form-select" required>
                                    <option value="">Cargando profesores...</option>
                                </select>
                                <small class="text-muted">Mismo profesor para todos los grupos</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-end">
                                <button type="button" class="btn btn-primary" onclick="mostrarGridHorarios()">
                                    <i class="bi bi-calendar-plus me-2"></i>Continuar a Configuración de Horarios
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Paso 3: Grid de Horarios -->
                    <div id="gridHorarios" style="display:none;">
                        <label class="form-label fw-bold">3. Seleccionar Ambiente y Horarios</label>
                        
                        <!-- Selector de Ambiente -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Ambiente (Aula o Laboratorio):</label>
                                <select class="form-select" id="selectAmbiente">
                                    <option value="">Cargando ubicaciones...</option>
                                </select>
                                <small class="text-muted">Selecciona el ambiente donde se realizarán las clases de laboratorio</small>
                            </div>
                        </div>
                        
                        <p class="text-muted">Haz click en las celdas para seleccionar los horarios de cada grupo. Verde = seleccionado, colores = ocupado por otro horario del curso</p>

                        <div id="contenedorGrids"></div>

                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-success btn-lg" id="btnCrear">
                                <i class="bi bi-check-circle me-2"></i>Crear Laboratorios
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- LABORATORIOS EXISTENTES -->
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Laboratorios Creados</h5>
            </div>
            <div class="card-body">
                {% if labs_por_curso %}
                {% for curso_codigo, labs in labs_por_curso.items %}
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <strong>{{ labs.0.curso.codigo }}</strong> - {{ labs.0.curso.nombre }}
                        </h6>
                        <div>
                            {% if labs.0.publicado %}
                            <span class="badge bg-success me-2">Publicado</span>
                            <form method="post" action="{% url 'despublicar_laboratorios' curso_codigo %}"
                                style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-warning">
                                    <i class="bi bi-eye-slash"></i> Despublicar
                                </button>
                            </form>
                            {% else %}
                            <span class="badge bg-secondary me-2">No Publicado</span>
                            {% if not labs.0.es_preliminar %}
                            <form method="post" action="{% url 'publicar_laboratorios' curso_codigo %}"
                                style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="bi bi-eye"></i> Publicar
                                </button>
                            </form>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        {% for lab in labs %}
                        <div class="col-md-4 mb-3">
                            <div class="card lab-card h-100 {% if lab.es_preliminar %}border-info{% endif %}">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="bi bi-cpu text-primary"></i> Grupo {{ lab.grupo }}
                                        {% if lab.es_preliminar %}
                                        <span class="badge bg-info text-dark ms-2" title="Horario asignado pero sin formalizar">Preliminar</span>
                                        {% endif %}
                                    </h5>
                                    <p class="card-text mb-2">
                                        <strong>Horario:</strong><br>
                                        {% if lab.horarios_completos %}
                                            {% for horario_bloque in lab.horarios_completos %}
                                                {{ horario_bloque.get_dia_semana_display }}: {{ horario_bloque.hora_inicio }} - {{ horario_bloque.hora_fin }}
                                                {% if not forloop.last %}<br>{% endif %}
                                            {% endfor %}
                                        {% else %}
                                            {{ lab.horario.get_dia_semana_display }}<br>
                                            {{ lab.horario.hora_inicio }} - {{ lab.horario.hora_fin }}
                                        {% endif %}
                                    </p>
                                    {% if lab.horario.ubicacion or lab.ubicacion %}
                                    <p class="card-text mb-2">
                                        <strong>Ubicación:</strong> 
                                        {% if lab.ubicacion %}
                                            {{ lab.ubicacion.nombre }}
                                        {% else %}
                                            {{ lab.horario.ubicacion.nombre }}
                                        {% endif %}
                                    </p>
                                    {% endif %}
                                    {% if not lab.es_preliminar %}
                                    <p class="card-text">
                                        <span
                                            class="badge badge-cupos {% if lab.cupos_disponibles > 5 %}bg-success{% elif lab.cupos_disponibles > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                            Cupos: {{ lab.cupos_ocupados }}/{{ lab.capacidad_maxima }}
                                        </span>
                                    </p>
                                    <form method="post" action="{% url 'eliminar_laboratorio' lab.id %}"
                                        onsubmit="return confirm('¿Eliminar este laboratorio?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </form>
                                    {% else %}
                                    <p class="card-text">
                                        <small class="text-muted">
                                            <i class="bi bi-info-circle"></i> Este horario fue creado en "Asignar Horarios". 
                                            Crea un grupo formal para poder publicarlo.
                                        </small>
                                    </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <hr>
                {% endfor %}
                {% else %}
                <p class="text-muted text-center">No hay laboratorios creados aún.</p>
                {% endif %}
            </div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const DIAS = [
            { value: 1, text: 'Lunes' },
            { value: 2, text: 'Martes' },
            { value: 3, text: 'Miércoles' },
            { value: 4, text: 'Jueves' },
            { value: 5, text: 'Viernes' },
            { value: 6, text: 'Sábado' }
        ];

        const BLOQUES_HORARIOS = [
            ['07:00', '07:50'],
            ['07:50', '08:40'],
            ['08:50', '09:40'],
            ['09:40', '10:30'],
            ['10:40', '11:30'],
            ['11:30', '12:20'],
            ['12:20', '13:10'],
            ['13:10', '14:00'],
            ['14:00', '14:50'],
            ['14:50', '15:40'],
            ['15:50', '16:40'],
            ['16:40', '17:30'],
            ['17:40', '18:30'],
            ['18:30', '19:20'],
            ['19:20', '20:10']
        ];

        let ubicaciones = [];
        let profesores = [];
        let cursoInfo = null;
        let horariosSeleccionados = {}; // {grupo: [{dia, hora_inicio, hora_fin}, ...]}
        let ubicacionSeleccionada = ''; // Ambiente seleccionado para el grid

        // Cargar ubicaciones
        fetch('/laboratorio/ubicaciones/')
            .then(r => r.json())
            .then(data => {
                ubicaciones = data;
                // Cargar ubicaciones en el select
                const selectAmbiente = document.getElementById('selectAmbiente');
                if (selectAmbiente && data.length > 0) {
                    // Agrupar por tipo
                    const labs = data.filter(u => u.tipo === 'LABORATORIO');
                    const aulas = data.filter(u => u.tipo === 'AULA');
                    
                    let options = '<option value="">-- Seleccionar Ubicación --</option>';
                    
                    if (labs.length > 0) {
                        options += '<optgroup label="Laboratorios">';
                        options += labs.map(u => `<option value="${u.codigo}">${u.nombre} (Cap: ${u.capacidad})</option>`).join('');
                        options += '</optgroup>';
                    }
                    
                    if (aulas.length > 0) {
                        options += '<optgroup label="Aulas">';
                        options += aulas.map(u => `<option value="${u.codigo}">${u.nombre} (Cap: ${u.capacidad})</option>`).join('');
                        options += '</optgroup>';
                    }
                    
                    selectAmbiente.innerHTML = options;
                }
            })
            .catch(err => console.error('Error cargando ubicaciones:', err));
        
        // Cargar profesores
        fetch('/secretaria/cursos/profesores/')
            .then(r => r.json())
            .then(data => {
                profesores = data;
                const selectProfesor = document.getElementById('selectProfesor');
                if (selectProfesor && data.length > 0) {
                    selectProfesor.innerHTML = '<option value="">-- Seleccionar Profesor --</option>' +
                        data.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
                }
            })
            .catch(err => console.error('Error cargando profesores:', err));

        // Cuando se selecciona un curso
        document.getElementById('selectCurso').addEventListener('change', async function () {
            const codigo = this.value;
            if (!codigo) {
                document.getElementById('infoCurso').style.display = 'none';
                document.getElementById('paso2').style.display = 'none';
                document.getElementById('gridHorarios').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/laboratorio/curso/${codigo}/info/`);
                cursoInfo = await response.json();

                // Mostrar información del curso
                document.getElementById('horasLab').textContent = cursoInfo.curso.horas_laboratorio;

                const gruposHtml = cursoInfo.grupos.map(g =>
                    `<span class="badge bg-primary me-2">${g.grupo}: ${g.cantidad} estudiantes</span>`
                ).join('');
                document.getElementById('gruposExistentes').innerHTML = gruposHtml || 'Sin grupos';

                const horariosHtml = cursoInfo.horarios_existentes.map(h => {
                    const dia = DIAS.find(d => d.value == h.dia_semana)?.text || h.dia_semana;
                    let colorClass = 'bg-info';
                    if (h.tipo_clase === 'LABORATORIO') colorClass = 'bg-success';
                    else if (h.tipo_clase === 'TEORIA') colorClass = 'bg-primary';
                    else if (h.tipo_clase === 'PRACTICA') colorClass = 'bg-warning';
                    
                    return `<span class="badge ${colorClass} me-2">${h.tipo_clase} - Grupo ${h.grupo}: ${dia} ${h.hora_inicio}-${h.hora_fin}</span>`;
                }).join('');
                document.getElementById('horariosExistentes').innerHTML = horariosHtml || 'Sin horarios';

                document.getElementById('infoCurso').style.display = 'block';
                document.getElementById('paso2').style.display = 'block';

                // Sugerir grupos
                const gruposSugeridos = cursoInfo.grupos.map(g => g.grupo).join(',');
                document.getElementById('inputGrupos').value = gruposSugeridos;

            } catch (err) {
                console.error('Error cargando info del curso:', err);
                alert('Error al cargar información del curso');
            }
        });

        function mostrarGridHorarios() {
            const gruposInput = document.getElementById('inputGrupos').value;
            const grupos = gruposInput.split(',').map(g => g.trim().toUpperCase()).filter(g => g);

            if (grupos.length === 0) {
                alert('Debe especificar al menos un grupo');
                return;
            }

            document.getElementById('gridHorarios').style.display = 'block';
            
            // Agregar listener para cambio de ambiente
            const selectAmbiente = document.getElementById('selectAmbiente');
            selectAmbiente.addEventListener('change', function() {
                ubicacionSeleccionada = this.value;
                if (ubicacionSeleccionada) {
                    generarGridsParaGrupos(grupos);
                } else {
                    document.getElementById('contenedorGrids').innerHTML = 
                        '<div class="alert alert-warning">Por favor selecciona un laboratorio</div>';
                }
            });
            
            // Si ya hay una ubicación seleccionada, generar grids
            if (ubicacionSeleccionada) {
                generarGridsParaGrupos(grupos);
            }
        }
        
        function generarGridsParaGrupos(grupos) {
            const container = document.getElementById('contenedorGrids');
            container.innerHTML = '';
            horariosSeleccionados = {};

            grupos.forEach(grupo => {
                const div = document.createElement('div');
                div.className = 'card mb-3';
                div.innerHTML = `
            <div class="card-header bg-light">
                <strong>Grupo ${grupo}</strong> - Selecciona ${cursoInfo.curso.horas_laboratorio} horas académicas (bloques de 50 min)
                <span class="badge bg-primary ms-2" id="contador_${grupo}">0/${cursoInfo.curso.horas_laboratorio}</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered text-center">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 120px;">Hora</th>
                                ${DIAS.map(d => `<th>${d.text}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="grid_${grupo}">
                            ${BLOQUES_HORARIOS.map((bloque, idx) => `
                                <tr>
                                    <td><strong>${bloque[0]}<br>${bloque[1]}</strong></td>
                                    ${DIAS.map(dia => {
                    const ocupado = esHorarioOcupado(dia.value, bloque[0], bloque[1]);
                    const tipoClase = ocupado ? getTipoClaseOcupado(dia.value, bloque[0], bloque[1]) : null;
                    let bgClass = '';
                    let texto = 'Libre';
                    
                    if (ocupado) {
                        if (tipoClase === 'LABORATORIO') {
                            bgClass = 'bg-success bg-opacity-50';
                            texto = 'Lab';
                        } else if (tipoClase === 'TEORIA') {
                            bgClass = 'bg-primary bg-opacity-25';
                            texto = 'Teoría';
                        } else if (tipoClase === 'PRACTICA') {
                            bgClass = 'bg-warning bg-opacity-25';
                            texto = 'Práctica';
                        } else {
                            bgClass = 'bg-secondary bg-opacity-25';
                            texto = 'Ocupado';
                        }
                    }
                    
                    return `
                                            <td class="horario-cell ${ocupado ? 'ocupado ' + bgClass : ''}" 
                                                data-grupo="${grupo}"
                                                data-dia="${dia.value}"
                                                data-inicio="${bloque[0]}"
                                                data-fin="${bloque[1]}"
                                                onclick="${ocupado ? '' : `seleccionarHorario(this, '${grupo}')`}">
                                                <small class="${ocupado ? 'text-dark' : 'text-muted'}">${texto}</small>
                                            </td>
                                        `;
                }).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
                container.appendChild(div);
            });
        }

        function esHorarioOcupado(dia, horaInicio, horaFin) {
            if (!cursoInfo || !ubicacionSeleccionada) return false;

            // Filtrar solo horarios de la ubicación seleccionada o sin ubicación (placeholders)
            return cursoInfo.horarios_existentes.some(h => {
                const mismaUbicacion = h.ubicacion === ubicacionSeleccionada || !h.ubicacion;
                return mismaUbicacion &&
                    h.dia_semana == dia &&
                    ((h.hora_inicio >= horaInicio && h.hora_inicio < horaFin) ||
                        (h.hora_fin > horaInicio && h.hora_fin <= horaFin) ||
                        (h.hora_inicio <= horaInicio && h.hora_fin >= horaFin));
            });
        }

        function getTipoClaseOcupado(dia, horaInicio, horaFin) {
            if (!cursoInfo || !ubicacionSeleccionada) return null;

            const horario = cursoInfo.horarios_existentes.find(h => {
                const mismaUbicacion = h.ubicacion === ubicacionSeleccionada || !h.ubicacion;
                return mismaUbicacion &&
                    h.dia_semana == dia &&
                    ((h.hora_inicio >= horaInicio && h.hora_inicio < horaFin) ||
                        (h.hora_fin > horaInicio && h.hora_fin <= horaFin) ||
                        (h.hora_inicio <= horaInicio && h.hora_fin >= horaFin));
            });

            return horario ? horario.tipo_clase : null;
        }

        function seleccionarHorario(cell, grupo) {
            const dia = cell.dataset.dia;
            const inicio = cell.dataset.inicio;
            const fin = cell.dataset.fin;

            // Inicializar array si no existe
            if (!horariosSeleccionados[grupo]) {
                horariosSeleccionados[grupo] = [];
            }

            // Toggle selección
            if (cell.classList.contains('seleccionado')) {
                // Deseleccionar
                cell.classList.remove('seleccionado');
                cell.innerHTML = '<small class="text-muted">Libre</small>';
                
                // Quitar del array
                horariosSeleccionados[grupo] = horariosSeleccionados[grupo].filter(h => 
                    !(h.dia == dia && h.inicio == inicio && h.fin == fin)
                );
            } else {
                // Verificar si ya alcanzó el máximo de horas
                const horasSeleccionadas = horariosSeleccionados[grupo].length;
                const horasRequeridas = cursoInfo.curso.horas_laboratorio;
                
                if (horasSeleccionadas >= horasRequeridas) {
                    alert(`Ya seleccionaste ${horasRequeridas} hora(s) académica(s) para el grupo ${grupo}`);
                    return;
                }

                // Seleccionar
                cell.classList.add('seleccionado');
                cell.innerHTML = '<i class="bi bi-check-circle"></i>';

                horariosSeleccionados[grupo].push({ dia, inicio, fin });
            }
            
            // Actualizar contador
            const contador = document.getElementById(`contador_${grupo}`);
            if (contador) {
                const horasSeleccionadas = horariosSeleccionados[grupo].length;
                contador.textContent = `${horasSeleccionadas}/${cursoInfo.curso.horas_laboratorio}`;
                
                // Cambiar color según progreso
                contador.classList.remove('bg-primary', 'bg-success', 'bg-danger');
                if (horasSeleccionadas === cursoInfo.curso.horas_laboratorio) {
                    contador.classList.add('bg-success');
                } else if (horasSeleccionadas > cursoInfo.curso.horas_laboratorio) {
                    contador.classList.add('bg-danger');
                } else {
                    contador.classList.add('bg-primary');
                }
            }
        }

        // Al enviar el formulario, agregar los horarios seleccionados
        document.getElementById('formCrearLab').addEventListener('submit', function (e) {
            const gruposInput = document.getElementById('inputGrupos').value;
            const grupos = gruposInput.split(',').map(g => g.trim().toUpperCase()).filter(g => g);
            const profesorId = document.getElementById('selectProfesor').value;

            if (!ubicacionSeleccionada) {
                e.preventDefault();
                alert('Debe seleccionar un laboratorio (ambiente)');
                return;
            }
            
            if (!profesorId) {
                e.preventDefault();
                alert('Debe seleccionar un profesor encargado');
                return;
            }

            // Verificar que todos los grupos tengan horarios seleccionados
            for (const grupo of grupos) {
                if (!horariosSeleccionados[grupo] || horariosSeleccionados[grupo].length === 0) {
                    e.preventDefault();
                    alert(`Debe seleccionar al menos un horario para el grupo ${grupo}`);
                    return;
                }
                
                const horasSeleccionadas = horariosSeleccionados[grupo].length;
                const horasRequeridas = cursoInfo.curso.horas_laboratorio;
                
                if (horasSeleccionadas !== horasRequeridas) {
                    e.preventDefault();
                    alert(`El grupo ${grupo} requiere exactamente ${horasRequeridas} hora(s) académica(s). Actualmente tiene ${horasSeleccionadas}.`);
                    return;
                }

                // Agregar campos ocultos con la información de TODOS los bloques
                horariosSeleccionados[grupo].forEach((horario, index) => {
                    this.insertAdjacentHTML('beforeend', `
                <input type="hidden" name="dia_${grupo}_${index}" value="${horario.dia}">
                <input type="hidden" name="hora_inicio_${grupo}_${index}" value="${horario.inicio}">
                <input type="hidden" name="hora_fin_${grupo}_${index}" value="${horario.fin}">
            `);
                });
                
                // Agregar ubicación y cantidad de bloques
                this.insertAdjacentHTML('beforeend', `
                <input type="hidden" name="ubicacion_${grupo}" value="${ubicacionSeleccionada}">
                <input type="hidden" name="bloques_${grupo}" value="${horariosSeleccionados[grupo].length}">
            `);
            }
        });
    </script>

</body>

</html>