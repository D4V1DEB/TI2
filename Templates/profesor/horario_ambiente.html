{% extends "profesor/base.html" %}
{% load static %}
{% load get_item %}

{% block title %}Ambientes{% endblock %}

{% block content %}
<h3 class="mb-4">
    <i class="bi bi-calendar4-week me-2"></i>
    Disponibilidad de Ambientes
</h3>

<form method="get" class="mb-3 w-50">
    <label>Seleccionar ambiente</label>
    <select name="ambiente" class="form-select" onchange="this.form.submit()">
        {% for a in ambientes %}
        <option value="{{ a.id }}" {% if ambiente.id == a.id %}selected{% endif %}>
            {{ a.nombre }}
        </option>
        {% endfor %}
    </select>
</form>

<!-- CSRF para JS -->
<form id="csrf-form">{% csrf_token %}</form>

<table class="table table-bordered text-center">
    <thead class="table-dark">
        <tr>
            <th>Hora</th>
            {% for d in dias %}
            <th>{{ d|date:"D d/m" }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for idx, bloque in bloques %}
        <tr>
            <td><strong>{{ bloque.0 }} - {{ bloque.1 }}</strong></td>

            {% for d in dias %}
            {% with celda=tabla|get_item:d|get_item:idx %}
            <td class="align-middle" style="cursor:pointer;"
                onclick="reservar('{{ d|date:"Y-m-d" }}', '{{ bloque.0 }}', '{{ bloque.1 }}')">

                {% if celda %}
                    {% if celda.tipo_clase == 'RESERVA' %}
                        <span class="badge bg-success w-100">RESERVADO</span>
                    {% else %}
                        <span class="badge bg-primary w-100">CLASE</span>
                    {% endif %}
                {% else %}
                    <span class="text-muted small">Libre</span>
                {% endif %}

            </td>
            {% endwith %}
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endblock %}

<script>
function reservar(dia, hi, hf) {
    if (!confirm("Â¿Reservar este ambiente?")) return;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{% url 'reservar_ambiente' %}";

    const csrf = document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value;

    create(form, 'csrfmiddlewaretoken', csrf);
    create(form, 'ambiente', '{{ ambiente_seleccionado.id }}');
    create(form, 'dia', dia);
    create(form, 'hora_inicio', hi);
    create(form, 'hora_fin', hf);

    document.body.appendChild(form);
    form.submit();
}

function create(form, name, value) {
    const i = document.createElement('input');
    i.type = 'hidden';
    i.name = name;
    i.value = value;
    form.appendChild(i);
}
</script>
